# 2.6 绑定节点

## 2.6.1 基础介绍

在分布式游戏服务器中开发中，我们需要处理更多复杂的游戏业务场景，为了保证游戏性能、承载更多的玩家，我们往往会将与游戏业务相关的数据存放于服务器内存中。这样做的好处显而易见，但同时也会对于框架设计带来一定的挑战，一旦某位玩家的游戏数据落到了某一台逻辑服务器上，后续该玩家的所有游戏操作都必须在这台服务器上进行处理，否则就会导致游戏数据不一致的问题。

## 2.6.2 为何绑定节点

在网关服路由客户端消息时，需要根据用户（UID）来确定将消息路由到哪台节点服上进行处理。因此，绑定节点主要是为了将节点服（NID）、用户（UID）二者建立一定的绑定关系，从而使得网关服能够明确如何将客户端消息路由到正确的节点服上进行处理。

同时，在进行节点服间投递消息时，也需要通过用户（UID）来确定将消息路由到哪台节点服上进行处理。

通过以上分析，我们可以总结出绑定节点的两个核心作用：

1. **在网关服转发消息时，根据用户（UID）来确定将消息路由到哪台节点服进行处理。**
2. **在节点服投递消息时，根据用户（UID）来确定将消息路由到哪台节点服进行处理。**

## 2.6.3 如何绑定节点

在明确了为何要绑定节点之后，我们就可以回答如何绑定节点这个问题了，其实绑定节点用一句通俗的话表示就是：**谁（UID）跟哪台节点服（NID）建立了绑定关系**。

## 2.6.4 示例代码

以下完整示例详见：[bind-node-example](https://github.com/dobyte/due-docs/tree/master/examples/bind-node-example)

```go
package main

import (
	"github.com/dobyte/due/locate/redis/v2"
	"github.com/dobyte/due/registry/consul/v2"
	"github.com/dobyte/due/v2"
	"github.com/dobyte/due/v2/cluster/node"
	"github.com/dobyte/due/v2/codes"
	"github.com/dobyte/due/v2/errors"
	"github.com/dobyte/due/v2/log"
)

const (
	defaultUID      = 1
	defaultAccount  = "fuxiao"
	defaultPassword = "123456"
)

// 路由号
const (
	login = 1 // 登录
	join  = 2 // 加入
	play  = 3 // 游戏
)

func main() {
	// 创建容器
	container := due.NewContainer()
	// 创建用户定位器
	locator := redis.NewLocator()
	// 创建服务发现
	registry := consul.NewRegistry()
	// 创建节点组件
	component := node.NewNode(
		node.WithLocator(locator),
		node.WithRegistry(registry),
	)
	// 初始化应用
	initApp(component.Proxy())
	// 添加节点组件
	container.Add(component)
	// 启动容器
	container.Serve()
}

// 初始化应用
func initApp(proxy *node.Proxy) {
	proxy.Router().Group(func(group *node.RouterGroup) {
		// 登录
		group.AddRouteHandler(login, loginHandler)
		// 设置认证中间件
		group.Middleware(auth)
		// 加入
		group.AddRouteHandler(join, joinHandler, node.AuthorizedRoute)
		// 游戏
		group.AddRouteHandler(play, playHandler, node.StatefulRoute)
	})
}

// 基础响应
type baseRes struct {
	Code int `json:"code"`
}

// 请求
type loginReq struct {
	Account  string `json:"account"`
	Password string `json:"password"`
}

// 响应
type loginRes struct {
	Code int `json:"code"`
}

// 路由处理器
func loginHandler(ctx node.Context) {
	ctx.Task(func(ctx node.Context) {
		req := &loginReq{}
		res := &loginRes{}
		ctx.Defer(func() {
            if err := ctx.Response(res); err != nil {
                log.Errorf("response message failed: %v", err)
            }
        })

		if err := ctx.Parse(req); err != nil {
			log.Errorf("parse request message failed: %v", err)
			res.Code = codes.InternalError.Code()
			return
		}

		// 执行登录操作
		uid, err := doLogin(req)
		if err != nil {
			res.Code = codes.Convert(err).Code()
			return
		}

		// 绑定网关
		if err = ctx.BindGate(uid); err != nil {
			log.Errorf("bind gate failed: %v", err)
			res.Code = codes.InternalError.Code()
			return
		}

		res.Code = codes.OK.Code()
	})
}

// 请求
type joinReq struct {
	RoomID int64 `json:"roomID"`
}

// 响应
type joinRes struct {
	Code int `json:"code"`
}

// 加入
func joinHandler(ctx node.Context) {
	req := &joinReq{}
	res := &joinRes{}
	ctx.Defer(func() {
		if err := ctx.Response(res); err != nil {
			log.Errorf("response message failed: %v", err)
		}
	})

	if err := ctx.Parse(req); err != nil {
		log.Errorf("parse request message failed: %v", err)
		res.Code = codes.InternalError.Code()
		return
	}

	// 执行加入游戏操作
	if err := doJoin(ctx.UID(), req); err != nil {
		res.Code = codes.Convert(err).Code()
		return
	}

	// 绑定节点
	if err := ctx.BindNode(ctx.UID()); err != nil {
		log.Errorf("bind node failed: %v", err)
		res.Code = codes.InternalError.Code()
		return
	}

	res.Code = codes.OK.Code()
}

// 游戏
func playHandler(ctx node.Context) {
	req := &playReq{}
	res := &playRes{}
	ctx.Defer(func() {
		if err := ctx.Response(res); err != nil {
			log.Errorf("response message failed: %v", err)
		}
	})

	if err := ctx.Parse(req); err != nil {
		log.Errorf("parse request message failed: %v", err)
		res.Code = codes.InternalError.Code()
		return
	}

	// 执行游戏操作
	if err := doPlay(ctx.UID(), req); err != nil {
		res.Code = codes.Convert(err).Code()
		return
	}

	res.Code = codes.OK.Code()
}

// 请求
type playReq struct {
	Action string `json:"action"`
}

// 响应
type playRes struct {
	Code int `json:"code"`
}

// 认证中间件
func auth(middleware *node.Middleware, ctx node.Context) {
	if ctx.UID() == 0 {
		if err := ctx.Response(&baseRes{Code: codes.Unauthorized.Code()}); err != nil {
			log.Errorf("response message failed, err: %v", err)
		}
	} else {
		middleware.Next(ctx)
	}
}

// 执行登录操作
func doLogin(req *loginReq) (int64, error) {
	if req.Account != defaultAccount || req.Password != defaultPassword {
		return 0, errors.NewError(codes.InvalidArgument)
	}

	return defaultUID, nil
}

// 执行加入游戏操作
func doJoin(uid int64, req *joinReq) error {
	if req.RoomID != 1 {
		return errors.NewError(codes.InvalidArgument)
	}

	log.Infof("join room, uid: %v, roomID: %v", uid, req.RoomID)

	return nil
}

// 执行游戏操作
func doPlay(uid int64, req *playReq) error {
	if req.Action != "move" {
		return errors.NewError(codes.InvalidArgument)
	}

	log.Infof("play, uid: %v, action: %v", uid, req.Action)

	return nil
}
```