# 2.7 单线程模型

## 2.7.1 基础介绍

单线程模型狭义的理解是指：在一个进程中，有且仅有一个线程在执行任务，每个任务都必须等待前一个任务完成后才能开始执行。

我们都知道，一个进程中不可能仅存在一个线程，那么单线程广义的理解是什么呢？。

单线程广义的理解是指：在一个进程中，针对于某一类型的任务，有且仅有一个线程在执行，每个任务都必须等待前一个任务完成后才能开始执行。

也就是说，在一个进程中，我们可以同时有N个线程在处理N类不同类型的任务，这些任务间彼此没有任何依赖关系和资源共享的问题，那么此时，我们也可以将某个线程看作是某类任务的单线程。

单线程模型具有如下特点：
- **简单易用：单线程模型相对简单，易于理解和实现。**
- **顺序执行：所有任务都在一个线程中顺序执行，不存在并发问题。**
- **阻塞执行：如果一个任务阻塞了线程，那么整个进程就会被阻塞。**
- **资源共享：由于只有一个线程存在，因此不需要考虑资源共享和同步的问题。**

## 2.7.2 何时使用

严格要求执行顺序、高并发低延迟、非阻塞IO密集型等场景。例如：帧同步、状态同步等。

## 2.7.3 示例代码

以下完整示例详见：[single-thread-example](https://github.com/dobyte/due-docs/tree/master/examples/single-thread-example)

```go
package main

import (
	"fmt"

	"github.com/dobyte/due/locate/redis/v2"
	"github.com/dobyte/due/registry/consul/v2"
	"github.com/dobyte/due/v2"
	"github.com/dobyte/due/v2/cluster/node"
	"github.com/dobyte/due/v2/codes"
	"github.com/dobyte/due/v2/log"
	"github.com/dobyte/due/v2/utils/xtime"
)

// 路由号
const greet = 1

func main() {
	// 创建容器
	container := due.NewContainer()
	// 创建用户定位器
	locator := redis.NewLocator()
	// 创建服务发现
	registry := consul.NewRegistry()
	// 创建节点组件
	component := node.NewNode(
		node.WithLocator(locator),
		node.WithRegistry(registry),
	)
	// 初始化应用
	initApp(component.Proxy())
	// 添加节点组件
	container.Add(component)
	// 启动容器
	container.Serve()
}

// 初始化应用
func initApp(proxy *node.Proxy) {
	proxy.Router().AddRouteHandler(greet, greetHandler)
}

// 请求
type greetReq struct {
	Message string `json:"message"`
}

// 响应
type greetRes struct {
	Code    int    `json:"code"`
	Message string `json:"message"`
}

// 路由处理器
// 所有路由处理器都会在同一个线程中顺序执行，不存在并发问题。
func greetHandler(ctx node.Context) {
	req := &greetReq{}
	res := &greetRes{}
	ctx.Defer(func() {
		if err := ctx.Response(res); err != nil {
			log.Errorf("response message failed: %v", err)
		}
	})

	if err := ctx.Parse(req); err != nil {
		log.Errorf("parse request message failed: %v", err)
		res.Code = codes.InternalError.Code()
		return
	}

	log.Info(req.Message)

	res.Code = codes.OK.Code()
	res.Message = fmt.Sprintf("I'm tcp server, and the current time is: %s", xtime.Now().Format(xtime.DateTime))
}
```