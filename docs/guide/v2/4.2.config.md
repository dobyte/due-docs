# 4.2 配置中心

## 4.2.1 基础介绍

配置中心（config）区别于启动配置（etc）主要用于业务逻辑配置的读取、修改和监听。用法和启动配置（etc）完全一致，提供了 [file](https://github.com/dobyte/due/tree/main/config/file)、[consul](https://github.com/dobyte/due/tree/main/config/consul)、[etcd](https://github.com/dobyte/due/tree/main/config/etcd)、[nacos](https://github.com/dobyte/due/tree/main/config/nacos) 等多种配置源方案。你可以根据自身业务特点选择不同的配置源，也可以同时组合使用多种配置源来构建自己的配置方案。

## 4.2.2 支持格式

配置中心默认支持 [toml](https://toml.io/)、[yaml](https://yaml.org/)、[json](https://www.json.org/)、[xml](https://developer.mozilla.org/zh-CN/docs/Web/XML/XML_introduction) 等多种文件格式。你可以根据自身喜好自由选择文件格式。

> 注：yaml格式的配置支持.yaml和.yml两种后缀名

## 4.2.3 读写规则

框架中的配置文件均是以 **文件名[.参数名1[.参数名2...[.参数名n]]]** 的方式进行读写的。

> 注：例如a.b.c.d.toml这样的配置文件同样也是被支持的。读写时你只需要将a.b.c.d看成一个完整的文件名即可。

## 4.2.4 相关接口

2. 使用方式

```bash
import "github.com/dobyte/due/v2/config"
```

3. 接口文档

[https://pkg.go.dev/github.com/dobyte/due/v2/config](https://pkg.go.dev/github.com/dobyte/due/v2/config)

## 4.2.5 自定义配置源

如果你想使用其他的配置中心，[due](https://github.com/dobyte/due) 框架也提供相应的解决方案。你只需要实现以下配置源接口，然后通过config.SetConfigurator()设置一个新的附带自定义配置源的配置器，即可实现使用自定义配置了。

```go
type Source interface {
	// Name 配置源名称
	Name() string
	// Load 加载配置项
	Load(ctx context.Context, file ...string) ([]*Configuration, error)
	// Store 保存配置项
	Store(ctx context.Context, file string, content []byte) error
	// Watch 监听配置项
	Watch(ctx context.Context) (Watcher, error)
	// Close 关闭配置源
	Close() error
}

type Watcher interface {
	// Next 返回配置列表
	Next() ([]*Configuration, error)
	// Stop 停止监听
	Stop() error
}
```

## 4.2.6 file配置源示例

以下完整示例详见：[file](https://github.com/dobyte/due-examples/tree/master/config/file)

创建config.toml配置文件

```toml
timezone = "UTC"
```

构建配置读写示例

```go
package main

import (
	"context"
	"github.com/dobyte/due/v2/config"
	"github.com/dobyte/due/v2/config/file"
	"github.com/dobyte/due/v2/log"
	"time"
)

const filename = "config.toml"

func main() {
	// 设置文件配置中心
	config.SetConfigurator(config.NewConfigurator(config.WithSources(file.NewSource())))

	// 更新配置
	if err := config.Store(context.Background(), file.Name, filename, map[string]interface{}{
		"timezone": "Local",
	}); err != nil {
		log.Errorf("store config failed: %v", err)
		return
	}

	// 读取配置
	timezone := config.Get("config.timezone", "UTC").String()
	log.Infof("timezone: %s", timezone)

	// 更新配置
	if err := config.Store(context.Background(), file.Name, filename, map[string]interface{}{
		"timezone": "UTC",
	}); err != nil {
		log.Errorf("store config failed: %v", err)
		return
	}

	// 读取配置
	timezone = config.Get("config.timezone", "UTC").String()
	log.Infof("timezone: %s", timezone)
}
```

## 4.2.7 consul配置源示例

以下完整示例详见：[consul](https://github.com/dobyte/due-examples/tree/master/config/consul)

构建配置读写示例

```go
package main

import (
	"context"
	"github.com/dobyte/due/config/consul/v2"
	"github.com/dobyte/due/v2/config"
	"github.com/dobyte/due/v2/log"
	"time"
)

const filename = "config.toml"

func main() {
	// 设置consul配置中心
	config.SetConfigurator(config.NewConfigurator(config.WithSources(consul.NewSource())))

	// 更新配置
	if err := config.Store(context.Background(), consul.Name, filename, map[string]interface{}{
		"timezone": "Local",
	}); err != nil {
		log.Errorf("store config failed: %v", err)
		return
	}

	// 读取配置
	timezone := config.Get("config.timezone", "UTC").String()
	log.Infof("timezone: %s", timezone)

	// 更新配置
	if err := config.Store(context.Background(), consul.Name, filename, map[string]interface{}{
		"timezone": "UTC",
	}); err != nil {
		log.Errorf("store config failed: %v", err)
		return
	}

	// 读取配置
	timezone = config.Get("config.timezone", "UTC").String()
	log.Infof("timezone: %s", timezone)
}
```

## 4.2.8 etcd配置源示例

以下完整示例详见：[etcd](https://github.com/dobyte/due-examples/tree/master/config/etcd)

```go
package main

import (
	"context"
	"github.com/dobyte/due/config/etcd/v2"
	"github.com/dobyte/due/v2/config"
	"github.com/dobyte/due/v2/log"
	"time"
)

const filename = "config.toml"

func main() {
	// 设置etcd配置中心
	config.SetConfigurator(config.NewConfigurator(config.WithSources(etcd.NewSource())))

	// 更新配置
	if err := config.Store(context.Background(), etcd.Name, filename, map[string]interface{}{
		"timezone": "Local",
	}); err != nil {
		log.Errorf("store config failed: %v", err)
		return
	}

	// 读取配置
	timezone := config.Get("config.timezone", "UTC").String()
	log.Infof("timezone: %s", timezone)

	// 更新配置
	if err := config.Store(context.Background(), etcd.Name, filename, map[string]interface{}{
		"timezone": "UTC",
	}); err != nil {
		log.Errorf("store config failed: %v", err)
		return
	}

	// 读取配置
	timezone = config.Get("config.timezone", "UTC").String()
	log.Infof("timezone: %s", timezone)
}
```

## 4.2.9 nacos配置源示例

以下完整示例详见：[nacos](https://github.com/dobyte/due-examples/tree/master/config/nacos)

```go
package main

import (
	"context"
	"github.com/dobyte/due/config/nacos/v2"
	"github.com/dobyte/due/v2/config"
	"github.com/dobyte/due/v2/log"
)

const filename = "config.toml"

func main() {
	// 设置文件配置中心
	config.SetConfigurator(config.NewConfigurator(config.WithSources(nacos.NewSource())))

	// 更新配置
	if err := config.Store(context.Background(), nacos.Name, filename, map[string]interface{}{
		"timezone": "Local",
	}); err != nil {
		log.Errorf("store config failed: %v", err)
		return
	}

	// 读取配置
	timezone := config.Get("config.timezone", "UTC").String()
	log.Infof("timezone: %s", timezone)

	// 更新配置
	if err := config.Store(context.Background(), nacos.Name, filename, map[string]interface{}{
		"timezone": "UTC",
	}); err != nil {
		log.Errorf("store config failed: %v", err)
		return
	}

	// 读取配置
	timezone = config.Get("config.timezone", "UTC").String()
	log.Infof("timezone: %s", timezone)
}
```

## 4.2.10 自定义配置源示例

以下完整示例详见：[custom](https://github.com/dobyte/due-examples/tree/master/config/custom)

创建自定义的Zookeeper源

```go
package zookeeper

import (
	"context"
	"github.com/dobyte/due/v2/config"
)

const Name = "zookeeper"

type Source struct {
}

func NewSource() *Source {
	return &Source{}
}

// Name 配置源名称
func (s *Source) Name() string {
	return Name
}

// Load 加载配置项
func (s *Source) Load(ctx context.Context, file ...string) ([]*config.Configuration, error) {
	return nil, nil
}

// Store 保存配置项
func (s *Source) Store(ctx context.Context, file string, content []byte) error {
	return nil
}

// Watch 监听配置项
func (s *Source) Watch(ctx context.Context) (config.Watcher, error) {
	return &Watcher{}, nil
}

// Close 关闭配置源
func (s *Source) Close() error {
	return nil
}

type Watcher struct {
}

// Next 返回配置列表
func (w *Watcher) Next() ([]*config.Configuration, error) {
	return nil, nil
}

// Stop 停止监听
func (w *Watcher) Stop() error {
	return nil
}
```

使用自定义的Zookeeper配置源

```go
package main

import (
	"context"
	"due-examples/config/custom/zookeeper"
	"github.com/dobyte/due/v2/config"
	"github.com/dobyte/due/v2/log"
)

const filename = "config.toml"

func main() {
	// 设置zookeeper配置源
	config.SetConfigurator(config.NewConfigurator(config.WithSources(zookeeper.NewSource())))

	// 更新配置
	if err := config.Store(context.Background(), zookeeper.Name, filename, map[string]interface{}{
		"timezone": "Local",
	}); err != nil {
		log.Errorf("store config failed: %v", err)
		return
	}

	// 读取配置
	timezone := config.Get("config.timezone", "UTC").String()
	log.Infof("timezone: %s", timezone)

	// 更新配置
	if err := config.Store(context.Background(), zookeeper.Name, filename, map[string]interface{}{
		"timezone": "UTC",
	}); err != nil {
		log.Errorf("store config failed: %v", err)
		return
	}

	// 读取配置
	timezone = config.Get("config.timezone", "UTC").String()
	log.Infof("timezone: %s", timezone)
}
```